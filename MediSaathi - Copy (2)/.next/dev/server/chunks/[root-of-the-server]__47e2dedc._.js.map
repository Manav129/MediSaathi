{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/manav/Downloads/MediSaathi%20-%20Copy%20%282%29/MediSaathi%20-%20Copy%20%282%29/pages/api/auth/%5B...nextauth%5D.ts"],"sourcesContent":["import NextAuth from 'next-auth'\r\nimport GoogleProvider from 'next-auth/providers/google'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\n// Create a service role client that bypasses RLS\r\nconst supabaseAdmin = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY! || process.env.SUPABASE_JWT_SECRET!,\r\n  {\r\n    auth: {\r\n      autoRefreshToken: false,\r\n      persistSession: false\r\n    }\r\n  }\r\n)\r\n\r\nexport default NextAuth({\r\n  providers: [\r\n    GoogleProvider({\r\n      clientId: process.env.GOOGLE_CLIENT_ID!,\r\n      clientSecret: process.env.GOOGLE_CLIENT_SECRET!,\r\n    }),\r\n  ],\r\n  callbacks: {\r\n    async signIn({ user, account, profile }) {\r\n      if (account?.provider === 'google') {\r\n        try {\r\n          // Check if user profile exists in our custom users table\r\n          const { data: existingUser } = await supabaseAdmin\r\n            .from('users')\r\n            .select('*')\r\n            .eq('email', user.email)\r\n            .single()\r\n\r\n          // If user doesn't exist, create a profile\r\n          if (!existingUser) {\r\n            // Default to patient, this will be updated by the client-side logic\r\n            const { error } = await supabaseAdmin\r\n              .from('users')\r\n              .insert({\r\n                email: user.email!,\r\n                full_name: user.name || '',\r\n                avatar_url: user.image || '',\r\n                user_type: 'patient', // Default, will be updated\r\n                created_at: new Date().toISOString(),\r\n                updated_at: new Date().toISOString()\r\n              })\r\n\r\n            if (error) {\r\n              console.log(\"------------------\");\r\n              console.log(\"Error because of not able to create a user in table\");\r\n              console.error('Error creating user profile:', error)\r\n              return false\r\n            }\r\n          }\r\n          return true\r\n        } catch (error) {\r\n          console.error('Sign-in error:', error)\r\n          return false\r\n        }\r\n      }\r\n      return true\r\n    },\r\n    async session({ session, token }) {\r\n      // Add custom user data to session\r\n      if (session?.user?.email) {\r\n        const { data: userData } = await supabaseAdmin\r\n          .from('users')\r\n          .select('*')\r\n          .eq('email', session.user.email)\r\n          .single()\r\n\r\n        if (userData) {\r\n          session.user.userType = userData.user_type\r\n          session.user.userId = userData.id\r\n          session.user.fullName = userData.full_name\r\n        }\r\n      }\r\n      return session\r\n    },\r\n    async redirect({ url, baseUrl }) {\r\n      // If it's a sign-in redirect, go to the dashboard\r\n      if (url === `${baseUrl}/api/auth/signin` || url === baseUrl) {\r\n        return `${baseUrl}/dashboard`\r\n      }\r\n      \r\n      // Custom redirect logic for other cases\r\n      if (url.startsWith('/')) {\r\n        return `${baseUrl}${url}`\r\n      }\r\n      \r\n      if (url.startsWith(baseUrl)) {\r\n        return url\r\n      }\r\n      \r\n      // Default to dashboard for successful sign-ins\r\n      return `${baseUrl}/dashboard`\r\n    },\r\n    async jwt({ token, user, account }) {\r\n      if (user) {\r\n        token.userId = user.id\r\n        token.email = user.email\r\n      }\r\n      return token\r\n    }\r\n  },\r\n  pages: {\r\n    signIn: '/login',\r\n    error: '/auth/error',\r\n  },\r\n  session: {\r\n    strategy: 'jwt',\r\n  },\r\n  debug: process.env.NODE_ENV === 'development',\r\n})"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,iDAAiD;AACjD,MAAM,gBAAgB,IAAA,iKAAY,gFAEhC,wPAA8C,QAAQ,GAAG,CAAC,mBAAmB,EAC7E;IACE,MAAM;QACJ,kBAAkB;QAClB,gBAAgB;IAClB;AACF;uCAGa,IAAA,4HAAQ,EAAC;IACtB,WAAW;QACT,IAAA,0KAAc,EAAC;YACb,UAAU,QAAQ,GAAG,CAAC,gBAAgB;YACtC,cAAc,QAAQ,GAAG,CAAC,oBAAoB;QAChD;KACD;IACD,WAAW;QACT,MAAM,QAAO,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE;YACrC,IAAI,SAAS,aAAa,UAAU;gBAClC,IAAI;oBACF,yDAAyD;oBACzD,MAAM,EAAE,MAAM,YAAY,EAAE,GAAG,MAAM,cAClC,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,SAAS,KAAK,KAAK,EACtB,MAAM;oBAET,0CAA0C;oBAC1C,IAAI,CAAC,cAAc;wBACjB,oEAAoE;wBACpE,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,cACrB,IAAI,CAAC,SACL,MAAM,CAAC;4BACN,OAAO,KAAK,KAAK;4BACjB,WAAW,KAAK,IAAI,IAAI;4BACxB,YAAY,KAAK,KAAK,IAAI;4BAC1B,WAAW;4BACX,YAAY,IAAI,OAAO,WAAW;4BAClC,YAAY,IAAI,OAAO,WAAW;wBACpC;wBAEF,IAAI,OAAO;4BACT,QAAQ,GAAG,CAAC;4BACZ,QAAQ,GAAG,CAAC;4BACZ,QAAQ,KAAK,CAAC,gCAAgC;4BAC9C,OAAO;wBACT;oBACF;oBACA,OAAO;gBACT,EAAE,OAAO,OAAO;oBACd,QAAQ,KAAK,CAAC,kBAAkB;oBAChC,OAAO;gBACT;YACF;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,kCAAkC;YAClC,IAAI,SAAS,MAAM,OAAO;gBACxB,MAAM,EAAE,MAAM,QAAQ,EAAE,GAAG,MAAM,cAC9B,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,SAAS,QAAQ,IAAI,CAAC,KAAK,EAC9B,MAAM;gBAET,IAAI,UAAU;oBACZ,QAAQ,IAAI,CAAC,QAAQ,GAAG,SAAS,SAAS;oBAC1C,QAAQ,IAAI,CAAC,MAAM,GAAG,SAAS,EAAE;oBACjC,QAAQ,IAAI,CAAC,QAAQ,GAAG,SAAS,SAAS;gBAC5C;YACF;YACA,OAAO;QACT;QACA,MAAM,UAAS,EAAE,GAAG,EAAE,OAAO,EAAE;YAC7B,kDAAkD;YAClD,IAAI,QAAQ,GAAG,QAAQ,gBAAgB,CAAC,IAAI,QAAQ,SAAS;gBAC3D,OAAO,GAAG,QAAQ,UAAU,CAAC;YAC/B;YAEA,wCAAwC;YACxC,IAAI,IAAI,UAAU,CAAC,MAAM;gBACvB,OAAO,GAAG,UAAU,KAAK;YAC3B;YAEA,IAAI,IAAI,UAAU,CAAC,UAAU;gBAC3B,OAAO;YACT;YAEA,+CAA+C;YAC/C,OAAO,GAAG,QAAQ,UAAU,CAAC;QAC/B;QACA,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE,OAAO,EAAE;YAChC,IAAI,MAAM;gBACR,MAAM,MAAM,GAAG,KAAK,EAAE;gBACtB,MAAM,KAAK,GAAG,KAAK,KAAK;YAC1B;YACA,OAAO;QACT;IACF;IACA,OAAO;QACL,QAAQ;QACR,OAAO;IACT;IACA,SAAS;QACP,UAAU;IACZ;IACA,OAAO,oDAAyB;AAClC"}}]
}